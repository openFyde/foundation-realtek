From 6bb06d8617815da31b8e3b769176ef230f0f8bcd Mon Sep 17 00:00:00 2001
From: yaozenhu <yaozenhu@realtek.com>
Date: Sun, 13 Apr 2025 23:21:12 -0400
Subject: [PATCH] add IsRtkchipAfbc to handle Modeset flow

---
 ui/ozone/platform/drm/gpu/hardware_display_controller.cc | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/ui/ozone/platform/drm/gpu/hardware_display_controller.cc b/ui/ozone/platform/drm/gpu/hardware_display_controller.cc
index c15c3db0c6a26..bafe6b9a4824b 100644
--- a/ui/ozone/platform/drm/gpu/hardware_display_controller.cc
+++ b/ui/ozone/platform/drm/gpu/hardware_display_controller.cc
@@ -81,6 +81,11 @@ bool IsRockchipAfbc(uint64_t modifier) {
                                  AFBC_FORMAT_MOD_SPARSE | AFBC_FORMAT_MOD_YTR);
 }
 
+bool IsRtkchipAfbc(uint64_t modifier) {
+  return modifier ==
+         DRM_FORMAT_MOD_ARM_AFBC(AFBC_FORMAT_MOD_BLOCK_SIZE_16x16 | AFBC_FORMAT_MOD_YTR);
+}
+
 }  // namespace
 
 HardwareDisplayController::HardwareDisplayController(
@@ -313,7 +318,7 @@ std::vector<uint64_t> HardwareDisplayController::GetSupportedModifiers(
     // AFBC for modeset buffers doesn't work correctly, as we can't fill them
     // with a valid AFBC buffer (b/172227166).
     // For now, don't use AFBC for modeset buffers.
-    if (is_modeset && IsRockchipAfbc(supported_modifier)) {
+    if (is_modeset && (IsRockchipAfbc(supported_modifier) || IsRtkchipAfbc(supported_modifier))) {
       supported_modifier = DRM_FORMAT_MOD_LINEAR;
     }
     return std::vector<uint64_t>{supported_modifier};
-- 
2.39.2

