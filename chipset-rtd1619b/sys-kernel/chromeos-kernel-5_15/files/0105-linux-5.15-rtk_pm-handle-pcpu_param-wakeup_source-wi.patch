From 1c224f43f3b8738c13afb9a5cde5e07e3c28f053 Mon Sep 17 00:00:00 2001
From: Edward Wu <edwardwu@realtek.com>
Date: Wed, 14 Aug 2024 07:02:18 +0800
Subject: [PATCH 105/108] linux-5.15: rtk_pm: handle pcpu_param->wakeup_source
 with mask

- wakeup: LAN, IRDA, CEC
-- LAN_EVENT, IR_EVENT, CEC_EVENT
-- CONFIG_R8169SOC, CONFIG_IR_RTK, CONFIG_RTK_HDMI_CEC

Change-Id: Ic09d9830d017ee15a25aa9a05ded4cb15e6b1e52
---
 drivers/soc/realtek/common/rtk_pm.c        |  2 ++
 drivers/soc/realtek/common/rtk_pm_common.c | 15 +++++++++++++++
 drivers/soc/realtek/common/rtk_pm_sysfs.c  |  5 +++++
 include/soc/realtek/rtk_pm.h               |  1 +
 4 files changed, 23 insertions(+)

diff --git a/drivers/soc/realtek/common/rtk_pm.c b/drivers/soc/realtek/common/rtk_pm.c
index 2cbd392ad089..3fa2f9c28f57 100644
--- a/drivers/soc/realtek/common/rtk_pm.c
+++ b/drivers/soc/realtek/common/rtk_pm.c
@@ -81,6 +81,8 @@ static int rtk_pm_prepare(struct device *dev)
 	struct pm_dev_param *lan_node = rtk_pm_get_param(LAN);
 	int ret = 0;
 
+	dev_pm->pcpu_param->wakeup_source &= rtk_pm_get_param_mask();
+
 	if (lan_node == NULL)
 		goto skip_set_dco_param;
 
diff --git a/drivers/soc/realtek/common/rtk_pm_common.c b/drivers/soc/realtek/common/rtk_pm_common.c
index e7139b2a2d92..99b487a9f433 100644
--- a/drivers/soc/realtek/common/rtk_pm_common.c
+++ b/drivers/soc/realtek/common/rtk_pm_common.c
@@ -40,6 +40,21 @@ struct pm_dev_param *rtk_pm_get_param(unsigned int id)
 }
 EXPORT_SYMBOL(rtk_pm_get_param);
 
+unsigned int rtk_pm_get_param_mask(void)
+{
+	/* CONFIG_R8169SOC, CONFIG_IR_RTK, CONFIG_RTK_HDMI_CEC */
+	unsigned long param_mask = ~(BIT(LAN_EVENT) | BIT(IR_EVENT) | BIT(CEC_EVENT));
+	struct pm_dev_param *node;
+
+	list_for_each_entry(node, &rtk_pm_param_list, list) {
+		if (node->dev_type)
+			param_mask |= BIT(node->dev_type - 1);
+	}
+
+	return (unsigned int)param_mask;
+}
+EXPORT_SYMBOL(rtk_pm_get_param_mask);
+
 void rtk_pm_set_pcpu_param(struct device *dev)
 {
 	struct pm_private *dev_pm = dev_get_drvdata(dev);
diff --git a/drivers/soc/realtek/common/rtk_pm_sysfs.c b/drivers/soc/realtek/common/rtk_pm_sysfs.c
index afbae6187e3e..a352014323cc 100644
--- a/drivers/soc/realtek/common/rtk_pm_sysfs.c
+++ b/drivers/soc/realtek/common/rtk_pm_sysfs.c
@@ -156,8 +156,12 @@ static ssize_t rtk_pm_wakeup_show(struct kobject *kobj,
 	struct pm_dev_param *pm_param = rtk_pm_get_param(PM);
 	struct pm_private *dev_pm = dev_get_drvdata(pm_param->dev);
 	unsigned int n = 0;
+	unsigned int param_mask = rtk_pm_get_param_mask();
 
 	for (i = 0; i < MAX_EVENT; i++) {
+		if (!(param_mask & BIT(i)))
+			continue;
+
 		if (dev_pm->pcpu_param->wakeup_source & BIT(i))
 			n += snprintf(buf + n, PAGE_SIZE, " * ");
 		else
@@ -181,6 +185,7 @@ static ssize_t rtk_pm_wakeup_store(struct kobject *kobj,
 
 	if (wakeup < MAX_EVENT) {
 		dev_pm->pcpu_param->wakeup_source ^= BIT(wakeup);
+		dev_pm->pcpu_param->wakeup_source &= rtk_pm_get_param_mask();
 		return count;
 	}
 
diff --git a/include/soc/realtek/rtk_pm.h b/include/soc/realtek/rtk_pm.h
index ed12c0daec58..342a04aec542 100644
--- a/include/soc/realtek/rtk_pm.h
+++ b/include/soc/realtek/rtk_pm.h
@@ -58,6 +58,7 @@ struct mem_check {
 extern void rtk_pm_init_list(void);
 extern void rtk_pm_add_list(struct pm_dev_param *pm_node);
 extern struct pm_dev_param *rtk_pm_get_param(unsigned int id);
+extern unsigned int rtk_pm_get_param_mask(void);
 extern int rtk_pm_create_sysfs(void);
 extern void rtk_pm_set_pcpu_param(struct device *dev);
 extern void rtk_pm_del_list(struct pm_dev_param *pm_node);
-- 
2.45.2

