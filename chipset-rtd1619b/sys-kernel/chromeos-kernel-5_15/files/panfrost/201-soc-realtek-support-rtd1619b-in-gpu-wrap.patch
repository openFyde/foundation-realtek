From f598b080c461383130f11e5b567a3a824cc9dbcd Mon Sep 17 00:00:00 2001
From: Edgar Lee <cylee12@realtek.com>
Date: Tue, 6 Feb 2024 17:00:21 +0800
Subject: [PATCH] soc: realtek: support rtd1619b in gpu-wrap

Change-Id: I72dd577b6727382f6db56448eaad32b0971a5173
---
 drivers/soc/realtek/gpu/rtk-gpu_wrap.c | 68 ++++++++++++++++++++++----
 1 file changed, 59 insertions(+), 9 deletions(-)

Index: kernel-5_15/drivers/soc/realtek/gpu/rtk-gpu_wrap.c
===================================================================
--- kernel-5_15.orig/drivers/soc/realtek/gpu/rtk-gpu_wrap.c
+++ kernel-5_15/drivers/soc/realtek/gpu/rtk-gpu_wrap.c
@@ -299,6 +299,31 @@ static int rtk_gpu_wrap_probe(struct pla
 		nvmem_cell_put(cell);
 	}
 
+	if (data->desc->request_syscon_dbgport) {
+		data->dbgprot = syscon_regmap_lookup_by_phandle(dev->of_node, "realtek,dbgprot");
+		if (IS_ERR(data->dbgprot)) {
+			dev_warn(dev, "error %pe: failed to get dbgprot syscon\n", data->dbgprot);
+			data->dbgprot = NULL;
+		}
+	}
+
+	if (data->desc->request_nvmem_bist_rst_ctrl) {
+		struct nvmem_cell *cell;
+	        unsigned char *buf;
+		size_t buf_size;
+
+		cell = nvmem_cell_get(dev, "bist_rst_ctrl");
+		if (IS_ERR(cell))
+			return dev_err_probe(dev, PTR_ERR(cell), "failed to get bist-rst-ctrl");
+
+		buf = nvmem_cell_read(cell, &buf_size);
+		dev_info(dev, "bist-rst-ctrl=%d\n", buf[0]);
+		if (buf[0] == 0x2)
+			data->auto_bist_enabled = 1;
+		kfree(buf);
+		nvmem_cell_put(cell);
+	}
+
 	if (data->desc->has_bisr) {
 		data->reg_bist = devm_platform_ioremap_resource_byname(pdev, "bist");
 		if (IS_ERR(data->reg_bist))
@@ -319,14 +344,6 @@ static int rtk_gpu_wrap_probe(struct pla
 	if (IS_ERR(data->rstc_bist))
 		return dev_err_probe(dev, PTR_ERR(data->rstc_bist), "failed to get bist reset\n");
 
-	if (data->desc->request_syscon_dbgport) {
-		data->dbgprot = syscon_regmap_lookup_by_phandle(dev->of_node, "realtek,dbgprot");
-		if (IS_ERR(data->dbgprot)) {
-			dev_warn(dev, "error %pe: failed to get dbgprot syscon\n", data->dbgprot);
-			data->dbgprot = NULL;
-		}
-	}
-
 
 	platform_set_drvdata(pdev, data);
 
