From dff8f0ebfd68ed9ba4dd3eee112b314bd35545cd Mon Sep 17 00:00:00 2001
From: Edward Wu <edwardwu@realtek.com>
Date: Fri, 19 Jul 2024 07:56:53 +0800
Subject: [PATCH] media: realtek: vpu: enable VE1 back for stateful legacy
 mode.

Change-Id: I034a481acb440e4bece7b19b10e7e437829690e2
---
 .../arm64/chromiumos-realtek.flavour.config   |  2 ++
 .../platform/realtek/vpu/stateful/Makefile    | 22 ++++++++++++++++++-
 .../media/platform/realtek/vpu/stateful/vpu.c |  2 --
 3 files changed, 23 insertions(+), 3 deletions(-)

diff --git a/chromeos/config/chromeos/arm64/chromiumos-realtek.flavour.config b/chromeos/config/chromeos/arm64/chromiumos-realtek.flavour.config
index 64a33c0f153a..e19d44d37fd4 100644
--- a/chromeos/config/chromeos/arm64/chromiumos-realtek.flavour.config
+++ b/chromeos/config/chromeos/arm64/chromiumos-realtek.flavour.config
@@ -114,5 +114,7 @@ CONFIG_REGULATOR_APW888X_CORE=y
 CONFIG_REGULATOR_APW8886=y
 CONFIG_RTK_GIC_EXT=y
 CONFIG_DEVFREQ_GOV_SIMPLE_ONDEMAND=y
+CONFIG_RTD16XXB_RTK_CODEC=y
+CONFIG_RTD16XXB_VE1_CODEC=y
 CONFIG_VIDEO_REALTEK=m
 CONFIG_VIDEO_RTK_VCODEC=m
diff --git a/drivers/media/platform/realtek/vpu/stateful/Makefile b/drivers/media/platform/realtek/vpu/stateful/Makefile
index 786af6849bf6..dc4e19276781 100644
--- a/drivers/media/platform/realtek/vpu/stateful/Makefile
+++ b/drivers/media/platform/realtek/vpu/stateful/Makefile
@@ -1,10 +1,30 @@
 # SPDX-License-Identifier: GPL-2.0
-obj-$(CONFIG_VIDEO_RTK_VCODEC) += rtkvdec.o rtkve2.o
+subdir-ccflags-y += -DANDROID
+subdir-ccflags-y += -DENABLE_SHOW_VIDEO_INFO
+subdir-ccflags-$(CONFIG_ENABLE_CC) += -DVPU_GET_CC
+subdir-ccflags-y += -I$(srctree)/drivers/soc/realtek/rtd16xxb/rtk_ve/ve1
+
+obj-$(CONFIG_VIDEO_RTK_VCODEC) += rtkvdec.o rtkve1.o rtkve2.o
 
 rtkvdec-y += \
 	drv_if.o \
 	vpu.o
 
+rtkve1-y += \
+	ve1_v4l2.o \
+	ve1_decode.o \
+	ve1_mem.o \
+	ve1_mm.o \
+	ve1_vdi.o \
+	ve1_vdi_osal.o \
+	ve1_vpu.o \
+	ve1_product.o \
+	ve1_vpuapifunc.o \
+	ve1_vpuapi.o \
+	ve1_wrapper.o
+
+rtkve1-$(CONFIG_COMPAT) += ve1_mem_compat.o
+
 rtkve2-y += \
 	ve2.o \
 	ve2rpc.o
diff --git a/drivers/media/platform/realtek/vpu/stateful/vpu.c b/drivers/media/platform/realtek/vpu/stateful/vpu.c
index 4c33d138be15..a62e8b6e867b 100644
--- a/drivers/media/platform/realtek/vpu/stateful/vpu.c
+++ b/drivers/media/platform/realtek/vpu/stateful/vpu.c
@@ -52,7 +52,6 @@ void vpu_cap_buf_done(struct v4l2_fh *fh, struct vb2_v4l2_buffer *buf, bool eos,
 		      enum vb2_buffer_state state);
 
 const static struct vpu_fmt out_fmt[] = {
-#if 0
 	/* video engine VE1 output format */
 	{
 		/* struct v4l2_pix_format */
@@ -218,7 +217,6 @@ const static struct vpu_fmt out_fmt[] = {
 		.misc.bufcnt = 4,
 		.misc.VideoEngine = VIDEO_ENGINE_1,
 	},
-#endif
 	/* video engine VE2 output format */
 	{
 		/* struct v4l2_pix_format */
-- 
2.45.2

